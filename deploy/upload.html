<!DOCTYPE html>
<html>

<head>
    <title>Upload App</title>
    <!-- https://attacomsian.com/blog/xhr-node-file-upload#building-an-html-form -->
    <script type="text/javascript" src="/asset/core/forge/forge.min.js"></script>
    <script type="text/javascript" src="/asset/core/util.js"></script>
    <script type="text/javascript" src="/asset/core/event.js"></script>
    <script type="text/javascript" src="/asset/core/net.js"></script>
    <script type="text/javascript" src="/asset/core/auth.js"></script>
</head>

<body>
    <form method="POST" enctype="multipart/form-data">
        <input type="file" name="files" multiple>
        <button type="submit" role="button">Upload File</button>
    </form>
</body>
<script type="text/javascript">
(function() {

    // if (assert()) {
    //     const form = document.querySelector('form');
    //     form.addEventListener('submit', e => {
    //         e.preventDefault();
    //         upload((res) => {
    //             exportBlock(res);
    //         });
    //     });
    // }

    function upload(callback) {
        const url = net.host + "/api/sv/upload/app";
        const files = document.querySelector('[name=files]').files;
        const formData = new FormData();

        Array.from(files).forEach(file => {
            formData.append("files", file);
        });

        // post form data
        const xhr = new XMLHttpRequest();


        // log response
        xhr.onload = () => {
            let res = JSON.parse(xhr.responseText);
            callback(res);
            console.log('res', res)
        };

        // create and send the reqeust
        xhr.open('POST', url);
        xhr.setRequestHeader("x-token", net.user.token);
        xhr.setRequestHeader("uid", net.user.uid);
        xhr.setRequestHeader("oid", net.user.uid);
        xhr.send(formData);
    }

    function exportBlock(res) {
        var api = "/api/sv/export/block";
        var options = {
            locResource: res.result[0].loc,
        };
        net.post(api, options, (re) => {
            console.log('export', re);
        });
    }

    function assert() {
        net.host = net.host || util.cookie.get('host');

        if (!net.user.uid) {
            alert('Please login to your app before upload');
            location = '/';
            return false;
        }

        if (!net.host) {
            alert('Please set value for net.host before upload');
            return false;
        }

        return true;
    }
})();
</script>

</html>